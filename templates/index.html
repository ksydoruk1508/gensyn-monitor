<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>{{ site_title }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: light;
      --bg: #f8f9fb;
      --text: #111;
      --muted: #666;
      --border: #ddd;
      --card-bg: #fff;
    }
    body.dark {
      --bg: #0f1116;
      --text: #f5f5f5;
      --muted: #bbb;
      --border: #2a2d37;
      --card-bg: #1a1d24;
      color-scheme: dark;
    }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, sans-serif;
      margin: 24px;
      transition: background .2s ease, color .2s ease;
    }
    h1 { margin: 0 0 12px; }
    .muted { color: var(--muted); }
    table { border-collapse: collapse; width: 100%; background: var(--card-bg); border-radius: 12px; overflow: hidden; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px; text-align: left; vertical-align: middle; }
    th { font-weight: 600; background: var(--card-bg); }
    th.sortable { cursor: pointer; user-select: none; position: relative; padding-right: 20px; }
    th.sortable::after { content: '⇅'; font-size: 11px; position: absolute; right: 6px; top: 50%; transform: translateY(-50%); opacity: .35; }
    th.sortable.sort-asc::after { content: '↑'; opacity: .9; }
    th.sortable.sort-desc::after { content: '↓'; opacity: .9; }
    th#gswarmHeader.sort-wins-desc::after { content: '↓W'; opacity: .9; font-weight: 700; }
    th#gswarmHeader.sort-wins-asc::after  { content: '↑W'; opacity: .9; font-weight: 700; }
    th#gswarmHeader.sort-rew-desc::after  { content: '↓R'; opacity: .9; font-weight: 700; }
    th#gswarmHeader.sort-rew-asc::after   { content: '↑R'; opacity: .9; font-weight: 700; }

    code { background: rgba(127,127,127,.12); padding: 2px 6px; border-radius: 6px; }
    body.dark code { background: rgba(255,255,255,.08); }
    .UP { color: #1a7f37; font-weight: 700; }
    .DOWN { color: #b00020; font-weight: 700; }
    .pill { border: 1px solid var(--border); padding: 2px 6px; border-radius: 999px; font-size: 12px; white-space: nowrap; background: var(--bg); }
    .toolbar { display: flex; gap: 8px; margin: 10px 0 18px; align-items: center; flex-wrap: wrap; }
    .badge { font-size: 12px; border: 1px solid var(--border); border-radius: 999px; padding: 2px 8px; }
    button { padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border); background: transparent; cursor: pointer; color: inherit; }
    button:active { transform: translateY(1px); }
    tfoot td { padding-top: 12px; font-size: 12px; color: var(--muted); background: var(--card-bg); }
    .gswarm-card { display: flex; flex-direction: column; gap: 8px; font-size: 13px; }
    .gswarm-head { font-weight: 600; }
    .peer-list { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 10px; }
    .peer-badge { border: 1px solid var(--border); border-radius: 8px; padding: 8px; font-size: 12px; background: var(--card-bg); box-shadow: inset 0 0 0 1px rgba(0,0,0,0.02); }
    .peer-badge code { font-size: 12px; display: block; margin-bottom: 4px; word-break: break-all; }
    .peer-badge div:last-child { font-size: 12px; color: var(--text); }
    .warn { color: #d97706; font-size: 12px; }
    .small { font-size: 11px; }
    .detail-row td { background: rgba(127,127,127,.08); border-top: none; border-bottom: 1px solid var(--border); padding: 16px; }
    body.dark .detail-row td { background: rgba(255,255,255,.04); }
    .detail-row.hidden { display: none; }
    tr.node-row { cursor: pointer; }
    tr.node-row:hover { background: rgba(127,127,127,.08); }
    body.dark tr.node-row:hover { background: rgba(255,255,255,.05); }
    .alert-cell { text-align: center; }
    .alert-toggle { width: 16px; height: 16px; cursor: pointer; }
    .alert-toggle:disabled { cursor: not-allowed; opacity: .5; }
  </style>
</head>
<body data-admin-token="{{ admin_token|default('', true)|e }}">
  <h1>{{ site_title }}</h1>
  <div class="toolbar">
    <span class="badge">Порог неактивности: {{ threshold }}s</span>
    <button id="refreshBtn">Обновить</button>
    <button id="themeBtn">Dark mode</button>
    <span class="muted" id="updatedAt"></span>
  </div>
  <table id="tbl">
    <thead>
      <tr>
        <th id="nodeIdHeader" class="sortable">Node ID</th>
        <th>IP</th>
        <th id="statusHeader" class="sortable">Статус</th>
        <th>Последний heartbeat</th>
        <th>Возраст, сек</th>
        <th id="gswarmHeader" class="sortable">G-Swarm</th>
        <th>Alerts</th>
        <th>Meta</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot><tr><td colspan="8" class="muted">Автообновление каждые 10 секунд</td></tr></tfoot>
  </table>
  <script>
    const ADMIN_TOKEN = document.body.dataset.adminToken || '';
    const escapeMap = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };

    const fmtTs = (ts) => new Date(ts * 1000).toLocaleString();
    const esc = (str = '') => String(str).replace(/[&<>"']/g, (ch) => escapeMap[ch] || ch);
    const formatCheckTime = (str) => {
      if (!str) return '';
      const iso = str.includes('T') ? str : `${str.replace(' ', 'T')}Z`;
      const d = new Date(iso);
      return Number.isNaN(d.getTime()) ? str : d.toLocaleString();
    };

    const tbody = document.querySelector('#tbl tbody');
    const updatedAtEl = document.getElementById('updatedAt');
    const nodeIdHeader = document.getElementById('nodeIdHeader');
    const statusHeader = document.getElementById('statusHeader');
    const gswarmHeader = document.getElementById('gswarmHeader');

    const expandedNodes = new Set();
    let nodes = [];

    // Состояния сортировки
    let nodeSortOrder = null;      // 'asc' | 'desc' | null
    let statusSortOrder = null;    // 'down-first' | 'up-first' | null
    // gswarmSortMode: null | 'wins-desc' | 'wins-asc' | 'rew-desc' | 'rew-asc'
    let gswarmSortMode = null;

    function sortByNodeId(a, b, dir = 1) {
      const aMatch = a.node_id.match(/\d+/);
      const bMatch = b.node_id.match(/\d+/);
      if (aMatch && bMatch) {
        const aNum = parseInt(aMatch[0], 10);
        const bNum = parseInt(bMatch[0], 10);
        return dir * (aNum - bNum);
      }
      return dir * a.node_id.localeCompare(b.node_id);
    }

    function getTotals(n) {
      const totals = (n.gswarm && n.gswarm.stats && n.gswarm.stats.totals) || {};
      return {
        wins: Number.isFinite(+totals.wins) ? +totals.wins : -1,
        rewards: Number.isFinite(+totals.rewards) ? +totals.rewards : -1,
        votes: Number.isFinite(+totals.votes) ? +totals.votes : -1,
      };
    }

    function sortNodes(data) {
      // 0) Сортировка по G-Swarm (Wins/Rewards)
      if (gswarmSortMode) {
        return data.sort((a, b) => {
          const { wins: aw, rewards: ar } = getTotals(a);
          const { wins: bw, rewards: br } = getTotals(b);

          switch (gswarmSortMode) {
            case 'wins-desc':  if (aw !== bw) return bw - aw; break;
            case 'wins-asc':   if (aw !== bw) return aw - bw; break;
            case 'rew-desc':   if (ar !== br) return br - ar; break;
            case 'rew-asc':    if (ar !== br) return ar - br; break;
          }
          // тай-брейк по node_id
          return sortByNodeId(a, b, 1);
        });
      }

      // 1) Явная сортировка по статусу
      if (statusSortOrder) {
        const desired = statusSortOrder === 'down-first' ? ['DOWN', 'UP'] : ['UP', 'DOWN'];
        return data.sort((a, b) => {
          const ia = desired.indexOf(a.computed);
          const ib = desired.indexOf(b.computed);
          if (ia !== ib) return ia - ib;
          return sortByNodeId(a, b, 1);
        });
      }

      // 2) Явная сортировка по Node ID
      if (nodeSortOrder === 'asc' || nodeSortOrder === 'desc') {
        const dir = nodeSortOrder === 'asc' ? 1 : -1;
        return data.sort((a, b) => sortByNodeId(a, b, dir));
      }

      // 3) По умолчанию: DOWN выше, затем по node_id
      return data.sort((a, b) => {
        if ((a.computed === 'DOWN') === (b.computed === 'DOWN')) {
          return sortByNodeId(a, b, 1);
        }
        return a.computed === 'DOWN' ? -1 : 1;
      });
    }

    function renderNodes() {
      const data = sortNodes([...nodes]);
      tbody.innerHTML = '';

      // сброс индикаторов
      nodeIdHeader.classList.remove('sort-asc', 'sort-desc');
      statusHeader.classList.remove('sort-asc', 'sort-desc');
      gswarmHeader.classList.remove('sort-wins-desc','sort-wins-asc','sort-rew-desc','sort-rew-asc');

      // отметить активную сортировку
      if (nodeSortOrder === 'asc') nodeIdHeader.classList.add('sort-asc');
      else if (nodeSortOrder === 'desc') nodeIdHeader.classList.add('sort-desc');

      if (statusSortOrder === 'up-first') statusHeader.classList.add('sort-asc');
      else if (statusSortOrder === 'down-first') statusHeader.classList.add('sort-desc');

      if (gswarmSortMode) {
        const cls = {
          'wins-desc': 'sort-wins-desc',
          'wins-asc':  'sort-wins-asc',
          'rew-desc':  'sort-rew-desc',
          'rew-asc':   'sort-rew-asc',
        }[gswarmSortMode];
        if (cls) gswarmHeader.classList.add(cls);
      }

      for (const n of data) {
        const tr = document.createElement('tr');
        tr.classList.add('node-row');
        const metaFull = (n.meta || '').toString();
        const metaShort = metaFull.slice(0, 80);
        const alertChecked = n.gswarm_alert === false ? '' : ' checked';
        const allowAlerts = Boolean(ADMIN_TOKEN);
        const alertDisabled = allowAlerts ? '' : ' disabled';
        const alertTitle = allowAlerts ? 'Toggle Telegram alerts' : 'Alerts disabled (ADMIN_TOKEN missing)';

        tr.innerHTML = `
          <td><code>${esc(n.node_id)}</code></td>
          <td><code>${esc(n.ip || '')}</code></td>
          <td class="${n.computed}">${n.computed}</td>
          <td class="muted">${fmtTs(n.last_seen)}</td>
          <td>${n.age_sec}</td>
          <td>${renderGswarmSummary(n.gswarm)}</td>
          <td class="alert-cell"><input type="checkbox" class="alert-toggle"${alertChecked}${alertDisabled} title="${esc(alertTitle)}"></td>
          <td><span class="pill" title="${esc(metaFull)}">${esc(metaShort)}</span></td>
        `;

        const detail = document.createElement('tr');
        detail.className = 'detail-row hidden';
        detail.innerHTML = `<td colspan="8">${renderGswarmDetail(n.gswarm)}</td>`;

        tr.addEventListener('click', () => {
          if (detail.classList.toggle('hidden')) expandedNodes.delete(n.node_id);
          else expandedNodes.add(n.node_id);
        });

        tbody.appendChild(tr);
        tbody.appendChild(detail);
        if (expandedNodes.has(n.node_id)) detail.classList.remove('hidden');

        const toggle = tr.querySelector('.alert-toggle');
        if (toggle) {
          toggle.addEventListener('click', (ev) => ev.stopPropagation());
          toggle.addEventListener('change', (ev) => {
            if (!ADMIN_TOKEN) {
              ev.target.checked = !ev.target.checked;
              return;
            }
            setAlert(n.node_id, ev.target.checked, ev.target);
          });
        }
      }
    }

    function renderGswarmSummary(gs) {
      if (!gs) return '<span class="muted">n/a</span>';
      const stats = gs.stats || {};
      const totals = stats.totals || {};
      const votes = totals.votes ?? 'n/a';
      const rewards = totals.rewards ?? 'n/a';
      const wins = totals.wins ?? 'n/a';
      const peers = (gs.peer_ids && gs.peer_ids.length) ? gs.peer_ids.length : (totals.peers ?? 'n/a');
      const last = stats.last_check ? formatCheckTime(stats.last_check) : (gs.updated ? fmtTs(gs.updated) : '');
      const eoa = gs.eoa || stats.eoa;
      const tgid = gs.tgid || stats.tgid;
      return `
        <div>
          <div><strong>Votes ${votes}</strong> | Rewards ${rewards} | Wins ${wins}</div>
          <div class="muted small">Peers: ${peers}${last ? ` | Last ${esc(last)}` : ''}</div>
          ${eoa ? `<div class="muted small">EOA: <code>${esc(eoa)}</code></div>` : ''}
          ${tgid ? `<div class="muted small">TG ID: <code>${esc(tgid)}</code></div>` : ''}
        </div>
      `;
    }

    function renderGswarmDetail(gs) {
      if (!gs) return '<div class="muted">G-Swarm данные отсутствуют</div>';
      const stats = gs.stats || {};
      const totals = stats.totals || {};
      const per = stats.per_peer || {};
      const peers = (gs.peer_ids && gs.peer_ids.length ? gs.peer_ids : Object.keys(per)).filter(Boolean);
      const peerCards = peers.map((pid) => {
        const data = per[pid] || {};
        const votes = data.votes ?? 0;
        const rewards = data.rewards ?? 0;
        const wins = data.wins ?? 0;
        const rank = data.rank ? `Top #${esc(data.rank)}` : 'n/a';
        return `
          <div class="peer-badge">
            <div><code>${esc(pid)}</code></div>
            <div>${votes} votes | ${rewards} rewards | ${wins} wins | ${rank}</div>
          </div>
        `;
      }).join('');
      const missing = stats.missing_peers?.length
        ? `<div class="warn">Missing peers: ${stats.missing_peers.map((p) => esc(p)).join(', ')}</div>`
        : '';
      const last = stats.last_check ? formatCheckTime(stats.last_check) : (gs.updated ? fmtTs(gs.updated) : '');
      const eoa = gs.eoa || stats.eoa;
      const tgid = gs.tgid || stats.tgid;
      return `
        <div class="gswarm-card">
          <div class="gswarm-head">Votes ${totals.votes ?? 0} | Rewards ${totals.rewards ?? 0} | Wins ${totals.wins ?? 0}</div>
          <div class="peer-list">${peerCards || '<span class="muted">Peers не найдены</span>'}</div>
          ${missing}
          ${eoa ? `<div class="small">EOA: <code>${esc(eoa)}</code></div>` : ''}
          ${tgid ? `<div class="small">TG ID: <code>${esc(tgid)}</code></div>` : ''}
          ${last ? `<div class="small">Last: ${esc(last)}</div>` : ''}
        </div>
      `;
    }

    async function setAlert(nodeId, enabled, checkbox) {
      try {
        checkbox.disabled = true;
        const headers = { 'Content-Type': 'application/json' };
        if (ADMIN_TOKEN) headers['Authorization'] = `Bearer ${ADMIN_TOKEN}`;
        const res = await fetch('/api/nodes/gswarm/alert', {
          method: 'POST',
          headers,
          body: JSON.stringify({ node_id: nodeId, enabled }),
        });
        const payload = await res.json();
        if (!res.ok || !payload.ok) throw new Error(payload.error || `HTTP ${res.status}`);
      } catch (err) {
        checkbox.checked = !enabled;
        alert('Не удалось обновить настройки Telegram: ' + err);
      } finally {
        checkbox.disabled = false;
      }
    }

    async function load() {
      try {
        const res = await fetch('/api/nodes', { cache: 'no-store' });
        const data = await res.json();
        nodes = Array.isArray(data) ? data : [];
        renderNodes();
        updatedAtEl.textContent = 'Updated: ' + new Date().toLocaleTimeString();
      } catch (e) {
        updatedAtEl.textContent = 'Failed to refresh data';
      }
    }

    // Слушатели заголовков
    document.getElementById('refreshBtn').addEventListener('click', load);

    nodeIdHeader.addEventListener('click', () => {
      nodeSortOrder = nodeSortOrder === 'asc' ? 'desc' : 'asc';
      statusSortOrder = null;
      gswarmSortMode = null;
      renderNodes();
    });

    statusHeader.addEventListener('click', () => {
      statusSortOrder = statusSortOrder === 'down-first' ? 'up-first' : 'down-first';
      nodeSortOrder = null;
      gswarmSortMode = null;
      renderNodes();
    });

    // Клик по G-Swarm: Wins↓ → Wins↑ → Rewards↓ → Rewards↑ → …
    gswarmHeader.addEventListener('click', () => {
      const order = ['wins-desc', 'wins-asc', 'rew-desc', 'rew-asc'];
      const idx = order.indexOf(gswarmSortMode);
      gswarmSortMode = order[(idx + 1) % order.length];
      nodeSortOrder = null;
      statusSortOrder = null;
      renderNodes();
    });

    // Тема
    const themeBtn = document.getElementById('themeBtn');
    function applyTheme(theme) {
      document.body.classList.toggle('dark', theme === 'dark');
      themeBtn.textContent = theme === 'dark' ? 'Light mode' : 'Dark mode';
    }
    const savedTheme = localStorage.getItem('theme') || 'light';
    applyTheme(savedTheme);
    themeBtn.addEventListener('click', () => {
      const next = document.body.classList.contains('dark') ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme(next);
    });

    load();
    setInterval(load, 10000);
  </script>
</body>
</html>
